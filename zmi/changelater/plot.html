<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Flot Examples: Real-time updates</title>
    <link href="/examples.css" rel="stylesheet" type="text/css">
    <script language="javascript" type="text/javascript" src="/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="/jquery.flot.js"></script>
    <script type="text/javascript">

    $(function() {
        console.log("XXX");

        var data = []

        function updateNewDataPoint(x, y) {
            data.push([x, y]);
        }

        function normalize(beginning) {
            var newData = [];
            for (var i = 0, len = data.length; i < len; ++i) {
                if (data[i][0] >= beginning) {
                    newData.push(data[i]);
                }
            }
            newData.sort();
            data = newData;
        }

        function prepareGraphData(data, beginning) {
            var newData = [];
            for (var i = 0, len = data.length; i < len; ++i) {
                newData.push([data[i][0] - beginning, data[i][1]]);
            }
            return newData;
        }

        function newData(data) {
            $("#attributes").html("<pre>" + JSON.stringify(data, null, 2) + "</pre>");
            updateNewDataPoint(Date.now(), data.attributes.map.cpu_load.value);
        }

        // TODO(sbarzowski) better name
        function update2() {
            $.post("/attributes/", function(data) {
                //alert("success");
                newData(data);
            }).done(function() {
                //alert("success2");
            }).fail(function(xhr, status, error) {
                //alert("error");
                console.log(xhr);
                console.log(status);
                console.log(error);
            });
        }

        //update();
        var myInterval = setInterval(update2, 250);

		var plot = $.plot("#placeholder", [ data ], {
			series: {
				shadowSize: 0	// Drawing is faster without shadows
			},
			yaxis: {
				min: 0,
				max: 1
			},
			xaxis: {
				show: true,
				min: 0,
				max: 10000
			}
		});

		function update() {
		    // TODO(sbarzowski) - constants for stuff
			var t = Date.now() - 14000;
			normalize(t, data);

            console.log(data);

            if (data.length == 0) {
                return;
            }

            var t1 = Date.now() - 11000;

            var graphData = prepareGraphData(data, t1);

            console.log(graphData);
            plot.setData([graphData]);

			// Since the axes don't change, we don't need to call plot.setupGrid()

			plot.draw();

		}

		var myInterval = setInterval(update, 30);

		update();
	});

	</script>
</head>
<body>

<div id="header">
    <h2>Real-time updates</h2>
</div>

<div id="attributes">

</div>

<div id="content">

    <div class="demo-container">
        <div id="placeholder" class="demo-placeholder"></div>
    </div>

    <p>You can update a chart periodically to get a real-time effect by using a timer to insert the new data in the plot and redraw it.</p>

    <p>Time between updates: <input id="updateInterval" type="text" value="" style="text-align: right; width:5em"> milliseconds</p>

</div>

</body>
</html>
