<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ZMI</title>
    <link href="/zmi.css" rel="stylesheet" type="text/css">
    <script language="javascript" type="text/javascript" src="/jquery.js"></script>
    <script language="javascript" type="text/javascript" src="/lib.js"></script>
    <script type="text/javascript">
        $(function() {
            function buildAllZones(data) {
                console.log("ZONES");
                console.log(data);
                var zones = $("<div />");
                for (var zoneName in data) {
                    console.log(zoneName);
                    zones.append($("<h2 />").text(zoneName));
                    zones.append(buildAttributesTable(data[zoneName]));
                }
                return zones;
            }

            function update() {
                $.post("/attributes/", function(data) {
                    var table = buildAllZones(data);
                    console.log(table);
                    $("#zones").html(table);
                    $("#attributes").html(table);
                }).fail(function(xhr, status, error) {
                    console.log(xhr);
                    console.log(status);
                    console.log(error);
                });
            }

            //var myInterval = setInterval(update, 500);

            update();

            $("#install-query-form").submit(function(e) {
                e.preventDefault();
                var name = $("#queryName").val();
                var code = $("#queryCode").val();
                $.post("/installQuery/", {"queryName": name, "query": code}, function(data) {
                }).fail(function(xhr, status, error) {
                    console.log(xhr);
                    console.log(status);
                    console.log(error);
                });
            });

            function updateInstalledQueries() {
                $.post("/installedQueries/", function(data) {
                    var queries = $("<table />");
                    for (var q in data.map) {
                        var row = $("<tr />");
                        row.append($("<td />").text(q));
                        row.append($("<td />").text(attributeValueToString(data.map[q])));
                        var removeButton = $("<button class=\"remove-query-button\" type=\"button\">Remove</button>")
                            .data("queryName", q)
                            .click(function(e) {
                                console.log(e);
                                console.log(e.currentTarget);
                                var queryName = $(e.currentTarget).data("queryName");
                                console.log(queryName);
                                $.post("/uninstallQuery/", {"queryName": queryName}, function(data) {
                                }).fail(function(xhr, status, error) {
                                    console.log(xhr);
                                    console.log(status);
                                    console.log(error);
                                });
                            });
                        console.log(removeButton);
                        row.append($("<td />").html(removeButton));
                        queries.append(row);
                    }
                    $("#installed-query-list").html(queries);
                }).fail(function(xhr, status, error) {
                    console.log(xhr);
                    console.log(status);
                    console.log(error);
                });
            }

            updateInstalledQueries();
        });


    </script>
</head>
<body>

<h1>CloudAtlas</h1>

<div id="zmi-pane">
    <h2>Zones</h2>
    <div id="zones">

    </div>
</div>

<div id="control-pane">
    <h2>Installed queries</h2>
    <div id="installed-query-list"></div>
    <h2>Install query</h2>
    <form method="post" id="install-query-form">
        <label for="queryName">Query Name</label>
        <input id="queryName" name="queryName" type="text">
        <label for="queryCode">Query</label>
        <input id="queryCode" name="query" type="text">
        <input type="submit">
    </form>
</div>

</body>
</html>